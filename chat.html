<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Sophic AI - Your Personal Tutor</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    
    /* NUCLEAR DESIGN SYSTEM - MAXIMUM POLISH */
    :root {
      --bg-1: #080a0f;
      --bg-2: #0d1321;
      --acc-1: #6ea8ff;
      --acc-2: #9b8cff;
      --acc-green: #00ff88;
      --acc-red: #ff6b6b;
      --txt: #f6f7fb;
      --txt-dim: #b9bfd1;
      --txt-muted: #8e98af;
      --glass: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.12);
      --glass-brd: rgba(255,255,255,0.18);
      --blur: 24px;
      --shadow-soft: 0 8px 32px rgba(0,0,0,.10);
      --shadow-strong: 0 24px 80px rgba(0,0,0,.18);
      --shadow-glow: 0 0 40px rgba(110,168,255,.20);
      --spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* Fluid spacing scale - PERFECT SIZING */
      --space-1: clamp(4px, 0.8vw, 8px);
      --space-2: clamp(6px, 1.2vw, 12px);
      --space-3: clamp(10px, 1.8vw, 18px);
      --space-4: clamp(14px, 2.5vw, 24px);
      --section-pad: clamp(20px, 4vw, 40px);
      --radius: 16px;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body { 
      height: 100%; 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background: 
        radial-gradient(1200px 800px at 50% 5%, rgba(110,168,255,.06), transparent 70%),
        radial-gradient(800px 600px at 80% 90%, rgba(155,140,255,.04), transparent 70%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
      color: var(--txt);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Allow text selection */
    .msg, #userInput, .suggestion { 
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* NUCLEAR LIQUID BACKGROUND */
    #gl { 
      position: fixed; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      z-index: -2; 
      display: block;
    }

    /* MOBILE NAVIGATION */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 1001;
      width: 46px;
      height: 46px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--glass-brd);
      border-radius: 13px;
      cursor: pointer;
      backdrop-filter: blur(16px) saturate(120%);
      transition: all 0.4s var(--elastic);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-shadow: var(--shadow-soft);
      /* Better touch targets */
      min-height: 44px;
      min-width: 44px;
    }
    .mobile-menu-toggle span {
      width: 18px;
      height: 2px;
      background: var(--txt);
      border-radius: 1px;
      transition: all 0.4s var(--elastic);
      transform-origin: center;
    }
    .mobile-menu-toggle:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-strong), var(--shadow-glow);
      background: rgba(110,168,255,0.08);
    }
    .mobile-menu-toggle.active span:nth-child(1) {
      transform: rotate(45deg) translate(4px, 4px);
    }
    .mobile-menu-toggle.active span:nth-child(2) {
      opacity: 0;
      transform: scale(0);
    }
    .mobile-menu-toggle.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(8, 10, 15, 0.95);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.6s var(--spring);
      backdrop-filter: blur(30px) saturate(150%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .nav-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* MAIN LAYOUT */
    .app { 
      display: grid; 
      grid-template-columns: 300px 1fr; 
      height: 100vh; 
      gap: 1px;
      position: fixed;
      inset: 0;
    }

    /* NUCLEAR SIDEBAR */
    .sidebar {
      background: 
        linear-gradient(135deg, rgba(255,255,255,0.09) 0%, rgba(255,255,255,0.04) 50%, rgba(255,255,255,0.06) 100%);
      border: 1px solid var(--glass-brd);
      backdrop-filter: blur(28px) saturate(115%) brightness(105%);
      box-shadow: 
        inset 0 1px 0 rgba(255,255,255,0.20),
        0 16px 48px rgba(0,0,0,0.10),
        0 8px 32px rgba(110,168,255,0.05);
      display: flex;
      flex-direction: column;
      animation: sidebarEntrance 1s var(--elastic);
      position: relative;
      overflow: hidden;
      transition: all 0.6s var(--spring);
      border-radius: 0 16px 16px 0;
    }
    @keyframes sidebarEntrance {
      0% { 
        transform: translateX(-100%) rotate(-2deg); 
        opacity: 0; 
        filter: blur(6px);
      }
      70% {
        transform: translateX(6px) rotate(0.5deg);
        opacity: 0.8;
      }
      100% { 
        transform: translateX(0) rotate(0deg); 
        opacity: 1; 
        filter: blur(0px);
      }
    }

    .sidebar::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, 
        rgba(110,168,255,0.15) 0%,
        transparent 30%,
        transparent 70%,
        rgba(155,140,255,0.12) 100%);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: xor;
      -webkit-mask-composite: xor;
      pointer-events: none;
      animation: glowPulse 8s ease-in-out infinite;
    }
    @keyframes glowPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.7; }
    }

    .sidebar-header {
      padding: var(--space-4);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(8px);
      position: relative;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 900;
      font-size: 1.05rem;
      letter-spacing: 0.3px;
      background: linear-gradient(135deg, var(--acc-1), var(--acc-2), var(--acc-1));
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmerText 5s ease-in-out infinite;
    }
    @keyframes shimmerText {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .logo-dot {
      width: 9px;
      height: 9px;
      background: radial-gradient(circle at 30% 30%, var(--acc-1), var(--acc-2));
      border-radius: 50%;
      box-shadow: 0 0 14px rgba(110,168,255,0.6);
      animation: orbitalPulse 3.5s ease-in-out infinite;
    }
    @keyframes orbitalPulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg); 
        box-shadow: 0 0 14px rgba(110,168,255,0.6);
      }
      50% { 
        transform: scale(1.15) rotate(180deg); 
        box-shadow: 0 0 20px rgba(110,168,255,0.9);
      }
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* SETTINGS BUTTON */
    .settings-btn {
      width: 32px;
      height: 32px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 10px;
      color: var(--txt-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s var(--elastic);
      font-size: 14px;
      box-shadow: var(--shadow-soft);
      /* Better touch targets */
      min-height: 44px;
      min-width: 44px;
    }
    .settings-btn:hover {
      background: rgba(110,168,255,0.1);
      color: var(--acc-1);
      transform: scale(1.1) rotate(45deg);
      box-shadow: 0 4px 16px rgba(110,168,255,0.2);
    }

    .new-chat {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.10), 
        rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 11px;
      color: var(--txt);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s var(--elastic);
      font-size: 16px;
      font-weight: 700;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      /* Better touch targets */
      min-height: 44px;
      min-width: 44px;
    }
    .new-chat::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--acc-1), var(--acc-2));
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: inherit;
    }
    .new-chat:hover::before {
      opacity: 1;
    }
    .new-chat:hover {
      transform: translateY(-3px) scale(1.08) rotate(6deg);
      box-shadow: var(--shadow-strong), var(--shadow-glow);
      color: #0b1020;
    }

    .sessions {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-3);
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    .sessions::-webkit-scrollbar { width: 3px; }
    .sessions::-webkit-scrollbar-track { 
      background: rgba(255,255,255,0.03); 
      border-radius: 2px;
    }
    .sessions::-webkit-scrollbar-thumb { 
      background: linear-gradient(45deg, var(--acc-1), var(--acc-2)); 
      border-radius: 2px; 
      box-shadow: 0 2px 6px rgba(110,168,255,0.2);
    }

    /* ENHANCED SESSION WITH DELETE */
    .session {
      padding: var(--space-3);
      border-radius: var(--radius);
      cursor: pointer;
      background: rgba(255,255,255,0.015);
      border: 1px solid rgba(255,255,255,0.03);
      transition: all 0.4s var(--elastic);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* Better touch targets */
      min-height: 44px;
    }
    .session::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.06), 
        transparent 40%,
        rgba(110,168,255,0.03));
      opacity: 0;
      transition: all 0.4s var(--spring);
      border-radius: inherit;
    }
    .session:hover::before {
      opacity: 1;
    }
    .session:hover {
      transform: translateY(-2px) translateX(4px) scale(1.01);
      box-shadow: var(--shadow-strong), 0 0 20px rgba(110,168,255,0.12);
      border-color: rgba(110,168,255,0.2);
    }
    .session.active {
      background: linear-gradient(135deg, 
        rgba(110,168,255,0.10), 
        rgba(155,140,255,0.05));
      border-color: rgba(110,168,255,0.25);
      transform: translateY(-1px) translateX(3px);
      box-shadow: var(--shadow-soft), var(--shadow-glow);
    }

    .session-content {
      flex: 1;
      min-width: 0;
    }

    .session-title {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.3s ease;
    }
    .session:hover .session-title {
      color: rgba(110,168,255,1);
    }
    
    .session-preview {
      font-size: 0.75rem;
      color: var(--txt-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }
    .session:hover .session-preview {
      opacity: 1;
    }

    /* DELETE BUTTON */
    .delete-session {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(255,107,107,0.1);
      border: 1px solid rgba(255,107,107,0.2);
      color: var(--acc-red);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s var(--elastic);
      cursor: pointer;
      z-index: 10;
      /* Better touch targets */
      min-height: 44px;
      min-width: 44px;
    }
    .session:hover .delete-session {
      opacity: 1;
      transform: scale(1);
    }
    .delete-session:hover {
      background: var(--acc-red);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(255,107,107,0.3);
    }

    /* NUCLEAR MAIN PANEL */
    .main {
      display: flex;
      flex-direction: column;
      background: 
        linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
      border: 1px solid var(--glass-brd);
      backdrop-filter: blur(22px) saturate(118%) brightness(103%);
      animation: mainEntrance 1.1s var(--elastic) 0.15s both;
      position: relative;
      overflow: hidden;
      height: 100vh;
      border-radius: 16px 0 0 16px;
      box-shadow: 
        inset 0 1px 0 rgba(255,255,255,0.10),
        -6px 0 28px rgba(0,0,0,0.06);
    }
    @keyframes mainEntrance {
      0% { 
        transform: translateX(100%) scale(0.96); 
        opacity: 0; 
        filter: blur(10px);
      }
      70% {
        transform: translateX(-6px) scale(1.01);
        opacity: 0.8;
      }
      100% { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
        filter: blur(0px);
      }
    }

    /* NUCLEAR HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--section-pad);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      background: rgba(255,255,255,0.025);
      backdrop-filter: blur(14px);
      flex-shrink: 0;
      position: relative;
      z-index: 2;
    }

    /* FIXED TITLE - NO GRADIENT ON EMOJIS */
    .title { 
      font-weight: 800; 
      font-size: clamp(0.9rem, 1.8vw, 1.1rem);
      letter-spacing: -0.005em;
      color: var(--txt); /* Solid color for emoji compatibility */
      transition: all 0.3s ease;
    }
    .title:hover {
      transform: scale(1.02);
    }

    /* GRADIENT TEXT ONLY WHEN NEEDED */
    .title.gradient-text {
      background: linear-gradient(135deg, var(--txt), var(--acc-1), var(--acc-2));
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmerText 6s ease-in-out infinite;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .status { 
      display: flex; 
      align-items: center; 
      gap: var(--space-1); 
      color: var(--txt-dim); 
      font-size: 0.8rem;
      font-weight: 600;
      padding: 5px 10px;
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
    }
    .status-dot { 
      width: 7px; 
      height: 7px; 
      background: radial-gradient(circle at 30% 30%, var(--acc-green), var(--acc-1)); 
      border-radius: 50%; 
      box-shadow: 0 0 12px rgba(0,255,136,0.4);
      animation: statusPulse 3s ease-in-out infinite;
    }
    @keyframes statusPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.25); opacity: 0.8; }
    }

    /* LOADING STATES */
    .loading {
      position: relative;
      overflow: hidden;
    }
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255,255,255,0.1), 
        transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* SETTINGS MODAL */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(8, 10, 15, 0.9);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(20px);
      animation: modalFadeIn 0.3s ease;
    }
    .settings-modal.active {
      display: flex;
    }
    @keyframes modalFadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    .settings-content {
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      border: 1px solid var(--glass-brd);
      border-radius: 20px;
      padding: var(--space-4);
      max-width: 400px;
      width: 90%;
      backdrop-filter: blur(30px);
      box-shadow: var(--shadow-strong);
      animation: modalSlideIn 0.4s var(--elastic);
    }
    @keyframes modalSlideIn {
      0% { transform: scale(0.9) translateY(20px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    .settings-header h3 {
      font-size: 1.1rem;
      font-weight: 700;
    }
    .close-settings {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--txt-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 18px;
      /* Better touch targets */
      min-height: 44px;
      min-width: 44px;
    }
    .close-settings:hover {
      background: var(--acc-red);
      color: white;
      transform: scale(1.1);
    }

    .settings-option {
      padding: var(--space-3);
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      margin-bottom: var(--space-2);
      cursor: pointer;
      transition: all 0.3s var(--elastic);
      /* Better touch targets */
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .settings-option:hover {
      background: rgba(110,168,255,0.1);
      border-color: rgba(110,168,255,0.3);
      transform: translateY(-2px);
    }
    .settings-option h4 {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .settings-option p {
      font-size: 0.75rem;
      color: var(--txt-dim);
    }

    /* ONBOARDING SYSTEM */
    .onboarding {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--section-pad);
      text-align: center;
      animation: fadeInScale 1s var(--spring);
      position: relative;
      z-index: 1;
    }
    .onboarding.active {
      display: flex;
    }
    @keyframes fadeInScale {
      0% { 
        opacity: 0; 
        transform: scale(0.92) translateY(30px); 
        filter: blur(12px);
      }
      100% { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
        filter: blur(0px);
      }
    }

    .onboarding h1 {
      font-size: clamp(1.6rem, 4.5vw, 3rem);
      font-weight: 900;
      line-height: 1.1;
      letter-spacing: -0.025em;
      margin-bottom: var(--space-3);
      background: linear-gradient(135deg, 
        var(--txt) 0%, 
        var(--acc-1) 40%, 
        var(--acc-2) 80%,
        var(--txt) 100%);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: megaShimmer 7s ease-in-out infinite;
      text-wrap: balance;
    }
    @keyframes megaShimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .onboarding p {
      color: var(--txt-dim);
      font-size: clamp(0.85rem, 2.2vw, 1rem);
      margin-bottom: var(--space-4);
      max-width: 550px;
      line-height: 1.6;
      font-weight: 500;
    }

    .step-indicator {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      transition: all 0.4s var(--elastic);
    }
    .step-dot.active {
      background: linear-gradient(45deg, var(--acc-1), var(--acc-2));
      transform: scale(1.25);
      box-shadow: 0 0 16px rgba(110,168,255,0.5);
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: var(--space-3);
      max-width: 650px;
      margin-bottom: var(--space-4);
      width: 100%;
    }

    .option-card {
      padding: var(--space-3);
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.10), 
        rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.4s var(--elastic);
      text-align: center;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow-soft);
      /* Better touch targets */
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .option-card::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(135deg, 
        rgba(110,168,255,0.2), 
        transparent 40%,
        rgba(155,140,255,0.12));
      border-radius: inherit;
      opacity: 0;
      transition: all 0.4s var(--spring);
      z-index: -1;
      filter: blur(6px);
    }
    .option-card:hover::before {
      opacity: 1;
    }
    .option-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: var(--shadow-strong), 0 0 30px rgba(110,168,255,0.25);
      border-color: rgba(110,168,255,0.35);
    }
    .option-card.selected {
      background: linear-gradient(135deg, 
        rgba(110,168,255,0.18), 
        rgba(155,140,255,0.08));
      border-color: rgba(110,168,255,0.4);
      transform: translateY(-3px) scale(1.02);
      box-shadow: var(--shadow-strong), var(--shadow-glow);
    }
    .option-card.selected::before {
      opacity: 0.7;
    }

    .option-emoji {
      font-size: 1.8rem;
      margin-bottom: var(--space-2);
      display: block;
    }
    .option-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: var(--space-1);
    }
    .option-desc {
      font-size: 0.7rem;
      color: var(--txt-dim);
      line-height: 1.4;
    }

    .continue-btn {
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(135deg, var(--acc-1), var(--acc-2));
      border: none;
      border-radius: var(--radius);
      color: #0b1020;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s var(--elastic);
      box-shadow: var(--shadow-soft);
      opacity: 0.4;
      pointer-events: none;
      /* Better touch targets */
      min-height: 48px;
      min-width: 120px;
    }
    .continue-btn.enabled {
      opacity: 1;
      pointer-events: all;
    }
    .continue-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: var(--shadow-strong), var(--shadow-glow);
    }

    /* PERSONALIZED WELCOME STATE */
    .personalized-welcome {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--section-pad);
      text-align: center;
      animation: fadeInScale 1.1s var(--spring);
      overflow-y: auto;
      position: relative;
      z-index: 1;
    }
    .personalized-welcome.active {
      display: flex;
    }

    .personalized-welcome h1 {
      font-size: clamp(1.6rem, 4.5vw, 2.8rem);
      font-weight: 900;
      line-height: 1.05;
      letter-spacing: -0.025em;
      margin-bottom: var(--space-2);
      background: linear-gradient(135deg, var(--txt), var(--acc-1));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-wrap: balance;
    }

    .personalized-welcome .subtitle {
      color: var(--txt-dim);
      font-size: clamp(0.85rem, 2.2vw, 1rem);
      margin-bottom: var(--space-4);
      max-width: 550px;
      line-height: 1.6;
      font-weight: 500;
    }

    .personal-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--space-4);
      max-width: 900px;
      width: 100%;
      margin-bottom: var(--space-4);
    }

    /* ENHANCED PERSONAL CARDS */
    .personal-card {
      padding: var(--space-4);
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.10), 
        rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: calc(var(--radius) + 2px);
      cursor: pointer;
      transition: all 0.5s var(--elastic);
      text-align: left;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow-soft);
      /* Better touch targets */
      min-height: 140px;
    }
    .personal-card::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(135deg, 
        rgba(110,168,255,0.25), 
        transparent 40%,
        rgba(155,140,255,0.15));
      border-radius: inherit;
      opacity: 0;
      transition: all 0.5s var(--spring);
      z-index: -1;
      filter: blur(8px);
    }
    .personal-card:hover::before {
      opacity: 1;
    }
    .personal-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: var(--shadow-strong), 0 0 40px rgba(110,168,255,0.25);
      border-color: rgba(110,168,255,0.35);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
    }
    .card-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--acc-1), var(--acc-2));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #0b1020;
      transition: all 0.4s var(--elastic);
      box-shadow: 0 6px 20px rgba(110,168,255,0.25);
    }
    .personal-card:hover .card-icon {
      transform: scale(1.08) rotate(6deg);
      box-shadow: 0 8px 28px rgba(110,168,255,0.4);
    }

    .card-info h3 {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 3px;
    }
    .card-info .card-subtitle {
      font-size: 0.75rem;
      color: var(--txt-dim);
      font-weight: 500;
    }

    .card-description {
      font-size: 0.8rem;
      color: var(--txt-dim);
      line-height: 1.5;
      margin-bottom: var(--space-3);
    }

    /* ANIMATED PROGRESS BARS */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.08);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: var(--space-2);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--acc-1), var(--acc-2));
      border-radius: 3px;
      width: 0%; /* Start at 0 */
      transition: width 2s var(--spring); /* Smooth animation */
      box-shadow: 0 0 8px rgba(110,168,255,0.4);
    }
    .progress-fill.animated {
      width: var(--target-width); /* Animate to target */
    }
    .progress-text {
      font-size: 0.7rem;
      color: var(--txt-dim);
      font-weight: 600;
    }

    /* CHAT STATE */
    .chat-state {
      flex: 1;
      display: none;
      flex-direction: column;
      animation: chatEntrance 1s var(--spring);
      min-height: 0;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    .chat-state.active {
      display: flex;
    }
    @keyframes chatEntrance {
      0% { opacity: 0; transform: scale(0.97) translateY(15px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    /* MESSAGES - NO VIGNETTE */
    .messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: var(--section-pad);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      position: relative;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      /* Fix for iOS keyboard push */
      padding-bottom: env(keyboard-inset-height, var(--section-pad));
    }

    .messages::-webkit-scrollbar { width: 5px; }
    .messages::-webkit-scrollbar-track { 
      background: rgba(255,255,255,0.02);
      border-radius: 3px;
    }
    .messages::-webkit-scrollbar-thumb { 
      background: linear-gradient(45deg, var(--acc-1), var(--acc-2)); 
      border-radius: 3px; 
      box-shadow: 0 2px 6px rgba(110,168,255,0.2);
    }

    /* ENHANCED MESSAGE BUBBLES WITH REACTIONS */
    .msg {
      max-width: 75%;
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(18px) saturate(115%);
      position: relative;
      transition: all 0.5s var(--spring);
      animation: messageFloat 0.8s var(--elastic);
      line-height: 1.6;
      flex-shrink: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 0.85rem;
      box-shadow: var(--shadow-soft);
      font-weight: 500;
      /* Better spacing */
      margin-bottom: var(--space-2);
    }
    @keyframes messageFloat { 
      0% { 
        opacity: 0; 
        transform: translateY(30px) scale(0.92); 
        filter: blur(6px);
      } 
      60% {
        opacity: 1;
        transform: translateY(-3px) scale(1.01);
        filter: blur(1px);
      }
      100% { 
        transform: translateY(0) scale(1); 
        filter: blur(0px);
      } 
    }

    .msg::before {
      content: '';
      position: absolute;
      inset: -1px;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.12), 
        transparent 40%,
        rgba(110,168,255,0.06));
      border-radius: inherit;
      opacity: 0;
      transition: all 0.4s ease;
      pointer-events: none;
      z-index: -1;
    }
    .msg:hover::before {
      opacity: 1;
    }
    .msg:hover {
      transform: translateY(-3px) scale(1.008);
      box-shadow: var(--shadow-strong), 0 0 25px rgba(110,168,255,0.12);
    }

    .user {
      align-self: flex-end;
      background: linear-gradient(135deg, 
        rgba(110,168,255,0.12), 
        rgba(155,140,255,0.08));
      border-color: rgba(110,168,255,0.25);
      box-shadow: 
        var(--shadow-soft),
        0 0 20px rgba(110,168,255,0.06);
    }
    .bot {
      align-self: flex-start;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.06), 
        rgba(255,255,255,0.03));
    }

    /* MESSAGE REACTIONS */
    .message-reactions {
      position: absolute;
      top: -20px;
      right: var(--space-2);
      display: flex;
      gap: 4px;
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      padding: 6px 10px;
      backdrop-filter: blur(20px);
      opacity: 0;
      transform: translateY(10px) scale(0.9);
      transition: all 0.3s var(--elastic);
      pointer-events: none;
      box-shadow: var(--shadow-soft);
    }
    .msg:hover .message-reactions {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: all;
    }

    .reaction-btn {
      width: 32px;
      height: 32px;
      border-radius: 16px;
      background: transparent;
      border: none;
      color: var(--txt-dim);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s var(--elastic);
      /* Better touch targets */
      min-height: 44px;
      min-width: 44px;
    }
    .reaction-btn:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.15);
    }
    .reaction-btn.like:hover {
      background: rgba(0,255,136,0.2);
      color: var(--acc-green);
    }
    .reaction-btn.dislike:hover {
      background: rgba(255,107,107,0.2);
      color: var(--acc-red);
    }
    .reaction-btn.copy:hover {
      background: rgba(110,168,255,0.2);
      color: var(--acc-1);
    }

    /* ENHANCED SUGGESTIONS */
    .suggestions {
      padding: 0 var(--section-pad) var(--space-3);
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
      animation: suggestionsFloat 0.8s var(--spring);
      flex-shrink: 0;
    }
    @keyframes suggestionsFloat {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .suggestion {
      padding: var(--space-2) var(--space-3);
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.06), 
        rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      color: var(--txt-dim);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.1px;
      cursor: pointer;
      transition: all 0.4s var(--elastic);
      backdrop-filter: blur(8px);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
      /* Better touch targets */
      min-height: 36px;
      display: flex;
      align-items: center;
    }
    .suggestion::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--acc-1), var(--acc-2));
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: inherit;
    }
    .suggestion:hover::before {
      opacity: 1;
    }
    .suggestion:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: var(--shadow-strong), 0 0 25px rgba(110,168,255,0.25);
      color: #0b1020;
    }

    /* FIXED SIMPLIFY SUGGESTION BUTTON */
    .simplify-suggestion {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,107,107,0.08));
      border: 1px solid rgba(255,107,107,0.3);
      border-radius: 20px;
      color: var(--acc-red);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s var(--elastic);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-soft);
      /* Better touch targets */
      min-height: 36px;
      display: inline-flex;
      align-items: center;
    }
    .simplify-suggestion:hover {
      background: var(--acc-red);
      color: white;
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-strong), 0 0 20px rgba(255,107,107,0.3);
    }

    /* INPUT BAR - ENHANCED WITH KEYBOARD FIX */
    .input {
      padding: var(--space-4) var(--section-pad);
      border-top: 1px solid rgba(255,255,255,0.05);
      background: rgba(255,255,255,0.025);
      backdrop-filter: blur(14px);
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
      z-index: 10;
      /* iOS keyboard fix */
      padding-bottom: calc(var(--space-4) + env(safe-area-inset-bottom, 0px));
    }
    .glass {
      width: 100%;
      padding: var(--space-3);
      border-radius: 16px;
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border: 1px solid var(--glass-brd);
      backdrop-filter: blur(var(--blur));
      box-shadow: 
        0 20px 60px rgba(110,168,255,.08), 
        inset 0 1px 0 rgba(255,255,255,.18);
      transition: all 0.5s var(--spring);
      overflow: hidden;
    }

    .glass::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      pointer-events: none;
      background: 
        radial-gradient(600px 300px at var(--mx,50%) calc(var(--my,50%) - 12%), rgba(110,168,255,.10), transparent 45%),
        radial-gradient(300px 200px at calc(var(--mx,50%) + 6%) calc(var(--my,50%) + 6%), rgba(155,140,255,.08), transparent 45%);
      mix-blend-mode: screen;
      filter: blur(6px);
      opacity: 0.5;
      transition: opacity 0.4s ease;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      position: relative;
      z-index: 1;
    }

    .input-row .input {
      flex: 1;
      font: 600 0.9rem/1.2 Inter, system-ui;
      color: var(--txt);
      background: transparent;
      border: none;
      outline: none;
      padding: var(--space-2) var(--space-3);
      border-radius: 11px;
      backdrop-filter: blur(2px);
      min-height: 22px;
      max-height: 90px;
      overflow-y: auto;
      resize: none;
      transition: all 0.3s ease;
    }
    .input-row .input::placeholder {
      color: #9aa3b8;
    }

    .send {
      height: 42px;
      min-width: 42px;
      border-radius: 12px;
      border: 1px solid var(--glass-brd);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      color: var(--txt);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all 0.4s var(--elastic);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }
    .send::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--acc-1), var(--acc-2));
      opacity: 0;
      transition: all 0.4s ease;
      border-radius: inherit;
    }
    .send:hover::before {
      opacity: 1;
    }
    .send:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-strong), 0 0 30px rgba(110,168,255,0.3);
      color: #0b1020;
    }
    .send svg {
      display: block;
      transition: all 0.4s var(--elastic);
      position: relative;
      z-index: 1;
    }
    .send:hover svg {
      transform: scale(1.05) rotate(8deg);
    }

    .glass:focus-within {
      transform: translateY(-2px) scale(1.003);
      box-shadow: 
        0 25px 80px rgba(110,168,255,.12),
        inset 0 1px 0 rgba(255,255,255,.22);
      border-color: rgba(110,168,255,.20);
    }
    .glass:focus-within::before {
      opacity: 0.7;
    }

    /* TYPING INDICATOR */
    .typing {
      display: inline-flex;
      gap: var(--space-2);
      align-items: center;
      padding: var(--space-3) var(--space-4);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius);
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.06), 
        rgba(255,255,255,0.03));
      align-self: flex-start;
      animation: typingFloat 0.6s var(--spring);
      flex-shrink: 0;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow-soft);
    }
    @keyframes typingFloat {
      0% { opacity: 0; transform: translateY(15px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--acc-1), var(--acc-2));
      animation: nuclearBounce 1.8s infinite ease-in-out;
      box-shadow: 0 0 12px rgba(110,168,255,0.4);
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes nuclearBounce {
      0%, 60%, 100% {
        transform: translateY(0) scale(1);
        opacity: 0.7;
        box-shadow: 0 0 12px rgba(110,168,255,0.4);
      }
      30% {
        transform: translateY(-10px) scale(1.15);
        opacity: 1;
        box-shadow: 0 0 18px rgba(110,168,255,0.7);
      }
    }

    /* CONFIRMATION MODAL */
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(8, 10, 15, 0.9);
      z-index: 2500;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(20px);
      animation: modalFadeIn 0.3s ease;
    }
    .confirm-modal.active {
      display: flex;
    }

    .confirm-content {
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      border: 1px solid var(--glass-brd);
      border-radius: 18px;
      padding: var(--space-4);
      max-width: 350px;
      width: 90%;
      backdrop-filter: blur(30px);
      box-shadow: var(--shadow-strong);
      animation: modalSlideIn 0.4s var(--elastic);
      text-align: center;
    }

    .confirm-content h3 {
      margin-bottom: var(--space-2);
      font-size: 1rem;
    }
    .confirm-content p {
      color: var(--txt-dim);
      font-size: 0.85rem;
      margin-bottom: var(--space-4);
      line-height: 1.5;
    }

    .confirm-actions {
      display: flex;
      gap: var(--space-2);
      justify-content: center;
    }
    .confirm-btn {
      padding: var(--space-2) var(--space-3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s var(--elastic);
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 80px;
      /* Better touch targets */
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .confirm-btn.cancel {
      background: rgba(255,255,255,0.05);
      color: var(--txt-dim);
    }
    .confirm-btn.cancel:hover {
      background: rgba(255,255,255,0.1);
      color: var(--txt);
    }
    .confirm-btn.confirm {
      background: var(--acc-red);
      color: white;
      border-color: var(--acc-red);
    }
    .confirm-btn.confirm:hover {
      background: #ff5555;
      transform: scale(1.05);
    }

    /* TOAST NOTIFICATIONS */
    .toast {
      position: fixed;
      bottom: 100px;
      right: 20px;
      padding: var(--space-2) var(--space-3);
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      border: 1px solid var(--glass-brd);
      border-radius: 12px;
      color: var(--txt);
      font-size: 0.8rem;
      font-weight: 600;
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-soft);
      z-index: 3000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.4s var(--elastic);
      max-width: 300px;
      word-wrap: break-word;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .toast.success {
      border-color: rgba(0,255,136,0.3);
      background: linear-gradient(135deg, rgba(0,255,136,0.15), rgba(0,255,136,0.05));
    }
    .toast.error {
      border-color: rgba(255,107,107,0.3);
      background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,107,107,0.05));
    }

    /* RESPONSIVE DESIGN - ENHANCED */
    @media (max-width: 1024px) {
      .mobile-menu-toggle {
        display: flex;
      }
      
      .app {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100vh;
        z-index: 1000;
        transform: translateX(-100%);
        border-radius: 0 16px 16px 0;
      }
      
      .sidebar.open {
        transform: translateX(0);
        box-shadow: 
          12px 0 48px rgba(0,0,0,0.20),
          0 0 60px rgba(110,168,255,0.12);
      }
      
      .main {
        grid-column: 1;
        border-radius: 0;
      }
      
      .header {
        padding: var(--space-3) var(--space-4);
        padding-right: 70px;
      }

      /* Fix mobile spacing */
      .input {
        padding: var(--space-3);
        padding-bottom: calc(var(--space-3) + env(safe-area-inset-bottom, 0px));
      }
    }

    @media (max-width: 768px) {
      .options-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-2);
      }
      
      .personal-cards {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }
      
      .messages {
        padding: var(--space-4);
        gap: var(--space-2);
        padding-bottom: calc(var(--space-4) + env(keyboard-inset-height, 0px));
      }
      
      .msg {
        max-width: 88%;
        padding: var(--space-2) var(--space-3);
        font-size: 0.8rem;
      }
      
      .suggestions {
        padding: 0 var(--space-4) var(--space-2);
        gap: var(--space-1);
      }
      
      .send {
        height: 40px;
        min-width: 40px;
      }
      
      .input-row .input {
        font-size: 16px; /* Prevent zoom on iOS */
        padding: var(--space-2);
      }

      .session {
        padding: var(--space-2);
      }
      .session-title {
        font-size: 0.8rem;
      }
      .session-preview {
        font-size: 0.7rem;
      }

      .message-reactions {
        right: var(--space-1);
        top: -18px;
        padding: 4px 8px;
      }
      .reaction-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
        min-height: 36px;
        min-width: 36px;
      }

      .toast {
        bottom: 80px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .options-grid {
        grid-template-columns: 1fr;
      }
      
      .onboarding h1 {
        font-size: 1.8rem;
      }
      
      .personalized-welcome h1 {
        font-size: 1.8rem;
      }

      .header {
        padding: var(--space-2) var(--space-3);
        padding-right: 60px;
      }

      .messages {
        padding: var(--space-3);
      }

      .input {
        padding: var(--space-2);
        padding-bottom: calc(var(--space-2) + env(safe-area-inset-bottom, 0px));
      }
    }

    /* ACCESSIBILITY IMPROVEMENTS */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    @media (prefers-color-scheme: light) {
      /* Light mode overrides if needed */
    }

    /* HIGH CONTRAST MODE */
    @media (prefers-contrast: high) {
      :root {
        --glass-brd: rgba(255,255,255,0.3);
        --shadow-soft: 0 8px 32px rgba(0,0,0,.3);
      }
    }

    /* FOCUS STYLES FOR KEYBOARD NAVIGATION */
    .option-card:focus,
    .personal-card:focus,
    .session:focus,
    .suggestion:focus {
      outline: 2px solid var(--acc-1);
      outline-offset: 2px;
    }

    .continue-btn:focus,
    .send:focus,
    .settings-btn:focus,
    .new-chat:focus {
      outline: 2px solid var(--acc-1);
      outline-offset: 2px;
    }

    /* PERFORMANCE OPTIMIZATIONS */
    .main::before,
    .sidebar::before {
      will-change: transform;
    }

    .msg,
    .personal-card,
    .option-card {
      will-change: transform, box-shadow;
    }

    /* WebGL FALLBACK */
    .webgl-fallback {
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(ellipse at 20% 10%, rgba(110,168,255,0.1), transparent 50%),
        radial-gradient(ellipse at 80% 90%, rgba(155,140,255,0.08), transparent 50%),
        var(--bg-1);
      z-index: -3;
    }
  </style>

  <!-- MathJax Configuration -->
  <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$']],
      displayMath: [['$$', '$$']],
      processEscapes: true
    },
    startup: {
      ready: () => {
        console.log('ðŸš€ MathJax Nuclear Ready!');
        MathJax.startup.defaultReady();
      }
    }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <!-- WebGL Fallback -->
  <div class="webgl-fallback"></div>
  
  <!-- NUCLEAR LIQUID BACKGROUND -->
  <canvas id="gl" aria-hidden="true"></canvas>
  
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle navigation menu">
    <span></span><span></span><span></span>
  </button>
  
  <!-- Mobile Navigation Overlay -->
  <div class="nav-overlay" id="navOverlay">
    <a href="/" style="color: var(--acc-1); text-decoration: none; font-size: 1.4rem; font-weight: 700; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='scale(1)'">â† Back to Home</a>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h3>âš™ï¸ Settings</h3>
        <button class="close-settings" id="closeSettings">Ã—</button>
      </div>
      
      <div class="settings-option" onclick="resetProfile()">
        <h4>ðŸ”„ Reset Learning Profile</h4>
        <p>Change your grade, subjects, and learning preferences</p>
      </div>
      
      <div class="settings-option" onclick="exportData()">
        <h4>ðŸ“¥ Export Chat History</h4>
        <p>Download all your conversations as JSON</p>
      </div>
      
      <div class="settings-option" onclick="clearAllData()">
        <h4>ðŸ—‘ï¸ Clear All Data</h4>
        <p>Delete profile and all conversation history</p>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-content">
      <h3 id="confirmTitle">Are you sure?</h3>
      <p id="confirmMessage">This action cannot be undone.</p>
      <div class="confirm-actions">
        <button class="confirm-btn cancel" onclick="closeConfirmModal()">Cancel</button>
        <button class="confirm-btn confirm" id="confirmButton">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <div class="app">
    <!-- NUCLEAR SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-dot"></div>
          Sophic
        </div>
        <div class="header-actions">
          <button class="settings-btn" id="settingsBtn" title="Settings">âš™ï¸</button>
          <button class="new-chat" onclick="startNewChat()" title="New Chat">+</button>
        </div>
      </div>
      <div class="sessions" id="sessionsList">
        <!-- Sessions populated dynamically -->
      </div>
    </div>

    <!-- NUCLEAR MAIN PANEL -->
    <div class="main">
      <div class="header">
        <div class="title" id="chatTitle">Let's personalize your learning journey!</div>
        <div class="header-right">
          <div class="status">
            <div class="status-dot"></div>
            Online
          </div>
        </div>
      </div>

      <!-- ONBOARDING SYSTEM -->
      <div class="onboarding" id="onboardingState">
        <h1 id="onboardingTitle">Welcome to Sophic! ðŸš€</h1>
        <p id="onboardingSubtitle">Let's create your personalized learning experience</p>
        
        <div class="step-indicator" id="stepIndicator">
          <div class="step-dot active"></div>
          <div class="step-dot"></div>
          <div class="step-dot"></div>
        </div>

        <div class="options-grid" id="optionsGrid">
          <!-- Options populated dynamically -->
        </div>

        <button class="continue-btn" id="continueBtn" onclick="nextStep()">Continue</button>
      </div>

      <!-- PERSONALIZED WELCOME STATE -->
      <div class="personalized-welcome" id="personalizedWelcome">
        <h1 id="welcomeTitle">Welcome back!</h1>
        <p class="subtitle" id="welcomeSubtitle">Here's what we've prepared for you today</p>
        
        <div class="personal-cards" id="personalCards">
          <!-- Personal cards populated dynamically -->
        </div>
      </div>

      <!-- CHAT STATE -->
      <div class="chat-state" id="chatState">
        <div class="messages" id="messages"></div>
        <div class="suggestions" id="suggestions"></div>
      </div>

      <!-- INPUT BAR -->
      <div class="input">
        <div class="glass" id="glass">
          <div class="input-row">
            <textarea id="userInput" class="input" autocomplete="off" placeholder="Ask me anything about your studies..." aria-label="Type your question" rows="1"></textarea>
            <button class="send" id="send" aria-label="Ask Sophic">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M22 2L11 13"></path>
                <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('ðŸ”¥ðŸ’ŽðŸš€ NUCLEAR POLISHED PERSONALIZED CHAT LOADING... ðŸš€ðŸ’ŽðŸ”¥');

    // Global state
    let currentSessionId = null;
    let sessions = [];
    let userProfile = null;
    let currentOnboardingStep = 0;
    let cardContext = null;
    let inputDebounceTimer = null;
    
    // DOM references
    const onboardingState = document.getElementById('onboardingState');
    const personalizedWelcome = document.getElementById('personalizedWelcome');
    const chatState = document.getElementById('chatState');
    const messages = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sessionsList = document.getElementById('sessionsList');
    const chatTitle = document.getElementById('chatTitle');
    const suggestions = document.getElementById('suggestions');
    const sidebar = document.getElementById('sidebar');
    const glass = document.getElementById('glass');

    // Mobile menu elements
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const navOverlay = document.getElementById('navOverlay');

    // Modal elements
    const settingsModal = document.getElementById('settingsModal');
    const confirmModal = document.getElementById('confirmModal');
    
    let selectedOptions = {};

    // Onboarding data
    const onboardingSteps = [
      {
        title: "What grade are you in? ðŸ“š",
        subtitle: "This helps us tailor content to your level",
        options: [
          { id: "6", emoji: "ðŸ“–", title: "Class 6", desc: "Foundation level" },
          { id: "7", emoji: "ðŸ“˜", title: "Class 7", desc: "Intermediate basics" },
          { id: "8", emoji: "ðŸ“™", title: "Class 8", desc: "Advanced basics" },
          { id: "9", emoji: "ðŸ“•", title: "Class 9", desc: "Pre-board level" },
          { id: "10", emoji: "ðŸ“—", title: "Class 10", desc: "Board exam level" }
        ]
      },
      {
        title: "What subjects interest you most? ðŸŽ¯",
        subtitle: "Select all that apply - we'll prioritize these",
        multiple: true,
        options: [
          { id: "math", emoji: "ðŸ”¢", title: "Mathematics", desc: "Numbers & equations" },
          { id: "physics", emoji: "âš¡", title: "Physics", desc: "Forces & energy" },
          { id: "chemistry", emoji: "ðŸ§ª", title: "Chemistry", desc: "Elements & reactions" },
          { id: "biology", emoji: "ðŸ§¬", title: "Biology", desc: "Life & nature" },
          { id: "english", emoji: "ðŸ“", title: "English", desc: "Language & literature" },
          { id: "history", emoji: "ðŸ›ï¸", title: "History", desc: "Past & civilizations" },
          { id: "geography", emoji: "ðŸŒ", title: "Geography", desc: "Earth & places" },
          { id: "civics", emoji: "ðŸ›ï¸", title: "Civics", desc: "Government & society" }
        ]
      },
      {
        title: "How do you learn best? ðŸ§ ",
        subtitle: "This helps us adapt our teaching style",
        options: [
          { id: "visual", emoji: "ðŸ‘€", title: "Visual Learner", desc: "Diagrams, charts, examples" },
          { id: "stepbystep", emoji: "ðŸ“‹", title: "Step-by-Step", desc: "Detailed processes" },
          { id: "quick", emoji: "âš¡", title: "Quick & Direct", desc: "Straight to the point" },
          { id: "storytelling", emoji: "ðŸ“–", title: "Story-Based", desc: "Learn through narratives" },
          { id: "practical", emoji: "ðŸ”§", title: "Hands-On", desc: "Real-world applications" }
        ]
      }
    ];

    /* ====== PROGRESS PERSISTENCE SYSTEM ====== */
    function getOrCreateProgress(subject) {
      const key = `${subject}_progress`;
      let progress = localStorage.getItem(key);
      
      if (!progress) {
        // Generate realistic progress based on subject
        const baseProgress = {
          'math': Math.floor(Math.random() * 30) + 50, // 50-80%
          'physics': Math.floor(Math.random() * 25) + 35, // 35-60%
          'chemistry': Math.floor(Math.random() * 20) + 40, // 40-60%
          'biology': Math.floor(Math.random() * 35) + 45, // 45-80%
          'english': Math.floor(Math.random() * 40) + 30, // 30-70%
        };
        
        progress = baseProgress[subject] || Math.floor(Math.random() * 30) + 40;
        localStorage.setItem(key, progress);
      } else {
        progress = parseInt(progress);
      }
      
      return progress;
    }

    function incrementProgress(subject, amount = 5) {
      const key = `${subject}_progress`;
      let progress = parseInt(localStorage.getItem(key) || '0');
      progress = Math.min(100, progress + amount);
      localStorage.setItem(key, progress);
      return progress;
    }

    /* ====== NUCLEAR WebGL WITH ERROR HANDLING ====== */
    const canvas = document.getElementById('gl');
    let gl = null;
    let webglSupported = false;

    try {
      gl = canvas ? canvas.getContext('webgl', {antialias:true, preserveDrawingBuffer:true}) : null;
      webglSupported = !!gl;
    } catch(e) {
      console.warn('WebGL not supported, using fallback');
      webglSupported = false;
    }

    if (webglSupported && gl) {
      let W=0,H=0, DPR=Math.min(2, window.devicePixelRatio||1);
      const vert = `attribute vec2 p; void main(){ gl_Position = vec4(p,0.0,1.0); }`;
      const frag = `precision highp float; uniform vec2 r; uniform float t; uniform vec2 m;
float hash(vec2 p){return fract(sin(dot(p, vec2(127.1,311.7)))*43758.5453123);}
float noi(vec2 p){ vec2 i=floor(p); vec2 f=fract(p);
float a=hash(i); float b=hash(i+vec2(1.,0.)); float c=hash(i+vec2(0.,1.)); float d=hash(i+vec2(1.,1.));
vec2 u = f*f*(3.-2.*f); return mix(a,b,u.x)+ (c-a)*u.y*(1.-u.x) + (d-b)*u.x*u.y; }
float smin(float a, float b, float k){ float h=clamp(.5+.5*(b-a)/k,0.,1.); return mix(b,a,h)-k*h*(1.-h); }
float field(vec2 uv){ float d=1.; for(int i=0;i<6;i++){ float fi=float(i);
vec2 c = 0.32*vec2(sin(t*0.32+fi*1.35), cos(t*0.26+fi*1.08)); float rad = 0.23 + 0.065*sin(t*0.62+fi);
float s = length(uv-c) - rad; d = smin(d, s, 0.15); } return d; }
vec3 bg(vec2 uv){ uv = uv*0.5+0.5; vec3 c1 = vec3(0.02,0.04,0.08); vec3 c2 = vec3(0.05,0.07,0.12);
vec3 g = mix(c1, c2, smoothstep(0.,1.,uv.y)); float b1 = smoothstep(0.36,0.0, length(uv-vec2(0.28,0.18)) );
float b2 = smoothstep(0.52,0.0, length(uv-vec2(0.82,0.88)) ); vec3 a1 = vec3(0.42,0.66,1.0); vec3 a2 = vec3(0.59,0.52,1.0);
g += b1*a1*0.26 + b2*a2*0.22; return g; }
void main(){ vec2 uv = (gl_FragCoord.xy - 0.5*r)/r.y; vec2 par = (m - 0.5*r)/r.y * 0.08; uv += par;
float d = field(uv); vec2 e = vec2(0.0016, 0); float dx = field(uv+e.xy)-field(uv-e.xy); float dy = field(uv+e.yx)-field(uv-e.yx);
vec2 n = normalize(vec2(dx,dy)); vec2 offs = n * (0.065 + 0.042*noi(uv*3.2 + t*0.22));
vec3 colR = bg(uv + offs*1.03); vec3 colG = bg(uv + offs*0.97); vec3 colB = bg(uv + offs*0.93);
vec3 refr = vec3(colR.r, colG.g, colB.b); float glass = smoothstep(0.042, -0.022, d); float edge = smoothstep(0.085, 0.0, abs(d));
vec3 tint = mix(vec3(1.), vec3(0.92,0.94,1.0), 0.46); vec3 col = mix(bg(uv), refr*tint + 0.065*edge, glass);
float sweep = 0.0; sweep += 0.72*exp(-15.5*pow(abs(dot(n, normalize(vec2(0.72,0.52)))), 1.25)); sweep *= glass; col += sweep*vec3(0.84,0.91,1.0);
float vig = smoothstep(1.25, 0.22, length(uv)); col *= vig; gl_FragColor = vec4(col, 1.0); }`;
      
      function compile(type, src){ 
        const s = gl.createShader(type); 
        gl.shaderSource(s, src); 
        gl.compileShader(s);
        if(!gl.getShaderParameter(s, gl.COMPILE_STATUS)){ 
          throw new Error(gl.getShaderInfoLog(s)); 
        } 
        return s; 
      }
      
      try {
        const prog = gl.createProgram();
        gl.attachShader(prog, compile(gl.VERTEX_SHADER, vert));
        gl.attachShader(prog, compile(gl.FRAGMENT_SHADER, frag));
        gl.linkProgram(prog);
        gl.useProgram(prog);
        
        const buf = gl.createBuffer(); 
        gl.bindBuffer(gl.ARRAY_BUFFER, buf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1,  -1,1, 1,-1, 1,1]), gl.STATIC_DRAW);
        
        const loc = gl.getAttribLocation(prog, 'p'); 
        gl.enableVertexAttribArray(loc); 
        gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 0, 0);
        
        const uR = gl.getUniformLocation(prog, 'r'); 
        const uT = gl.getUniformLocation(prog, 't'); 
        const uM = gl.getUniformLocation(prog, 'm');
        
        let animationId = null;
        let isVisible = true;
        
        function resize(){ 
          if (!isVisible) return;
          const w = Math.floor(innerWidth * DPR), h = Math.floor(innerHeight * DPR);
          canvas.width=w; canvas.height=h; 
          canvas.style.width=innerWidth+'px'; 
          canvas.style.height=innerHeight+'px'; 
          gl.viewport(0,0,w,h); 
        }
        
        addEventListener('resize', resize, {passive:true}); 
        resize();
        
        let start = performance.now(), mx=innerWidth*DPR/2, my=innerHeight*DPR/2;
        
        addEventListener('pointermove', e=>{ 
          mx=e.clientX*DPR; my=e.clientY*DPR; 
          if (glass) {
            glass.style.setProperty('--mx', e.clientX+'px'); 
            glass.style.setProperty('--my', e.clientY+'px');
          }
        }, {passive:true});
        
        // Pause/resume animation based on visibility
        document.addEventListener('visibilitychange', () => {
          isVisible = !document.hidden;
          if (isVisible && !animationId) {
            loop();
          } else if (!isVisible && animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
          }
        });
        
        function loop(){
          if (!isVisible) return;
          
          const t = (performance.now()-start)/1000;
          gl.uniform2f(uR, canvas.width, canvas.height); 
          gl.uniform1f(uT, t); 
          gl.uniform2f(uM, mx, my);
          gl.drawArrays(gl.TRIANGLES, 0, 6);
          animationId = requestAnimationFrame(loop);
        }
        loop();
        
      } catch(e) {
        console.warn('WebGL shader compilation failed:', e);
        webglSupported = false;
      }
    }

    if (!webglSupported) {
      // Show fallback background
      canvas.style.display = 'none';
      const fallback = document.querySelector('.webgl-fallback');
      if (fallback) fallback.style.display = 'block';
    }

    /* ====== UTILITY FUNCTIONS ====== */
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      const container = document.getElementById('toastContainer');
      if (container) container.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
      }, 3000);
    }

    function showConfirmModal(title, message, onConfirm) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmButton').onclick = () => {
        onConfirm();
        closeConfirmModal();
      };
      confirmModal.classList.add('active');
    }

    function closeConfirmModal() {
      confirmModal.classList.remove('active');
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    /* ====== SETTINGS FUNCTIONS ====== */
    function resetProfile() {
      showConfirmModal(
        'ðŸ”„ Reset Learning Profile?',
        'This will reset your grade, subjects, and learning preferences. You\'ll need to set them up again.',
        () => {
          localStorage.removeItem('sophic_profile');
          // Clear progress data too
          const keys = Object.keys(localStorage);
          keys.forEach(key => {
            if (key.endsWith('_progress')) {
              localStorage.removeItem(key);
            }
          });
          
          userProfile = null;
          currentOnboardingStep = 0;
          selectedOptions = {};
          showOnboardingState();
          showToast('Profile reset successfully!');
          settingsModal.classList.remove('active');
        }
      );
    }

    function exportData() {
      const data = {
        profile: userProfile,
        sessions: sessions,
        progress: {},
        exportDate: new Date().toISOString()
      };
      
      // Export progress data too
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if (key.endsWith('_progress')) {
          data.progress[key] = localStorage.getItem(key);
        }
      });
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sophic-data-export.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Chat history exported successfully!');
      settingsModal.classList.remove('active');
    }

    function clearAllData() {
      showConfirmModal(
        'ðŸ—‘ï¸ Clear All Data?',
        'This will delete your profile and all conversation history permanently. This cannot be undone.',
        () => {
          localStorage.clear();
          userProfile = null;
          currentSessionId = null;
          sessions = [];
          currentOnboardingStep = 0;
          selectedOptions = {};
          messages.innerHTML = '';
          suggestions.innerHTML = '';
          showOnboardingState();
          renderSessions();
          showToast('All data cleared successfully!', 'error');
          settingsModal.classList.remove('active');
        }
      );
    }

    /* ====== Mobile Menu ====== */
    if (mobileMenuToggle && navOverlay) {
      mobileMenuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        mobileMenuToggle.classList.toggle('active');
        navOverlay.classList.toggle('active');
        document.body.style.overflow = navOverlay.classList.contains('active') ? 'hidden' : '';
      });

      navOverlay.addEventListener('click', (e) => {
        if (e.target === navOverlay) {
          sidebar.classList.remove('open');
          mobileMenuToggle.classList.remove('active');
          navOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    }

    /* ====== Settings Modal ====== */
    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettings = document.getElementById('closeSettings');
    
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('active');
      });
    }

    if (closeSettings) {
      closeSettings.addEventListener('click', () => {
        settingsModal.classList.remove('active');
      });
    }

    if (settingsModal) {
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove('active');
        }
      });
    }

    /* ====== MESSAGE REACTIONS ====== */
    function addMessageReactions(messageElement, isBot = true) {
      if (!isBot) return;
      
      const reactions = document.createElement('div');
      reactions.className = 'message-reactions';
      reactions.innerHTML = `
        <button class="reaction-btn like" title="Good explanation" onclick="reactToMessage(this, 'like')">ðŸ‘</button>
        <button class="reaction-btn dislike" title="Need simpler" onclick="reactToMessage(this, 'dislike')">ðŸ‘Ž</button>
        <button class="reaction-btn copy" title="Copy message" onclick="copyMessage(this)">ðŸ“‹</button>
      `;
      
      messageElement.appendChild(reactions);
    }

    function reactToMessage(btn, type) {
      const message = btn.closest('.msg');
      const messageText = message.textContent;
      
      // Enhanced visual feedback
      btn.style.transform = 'scale(1.4)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 200);
      
      if (type === 'like') {
        btn.style.color = 'var(--acc-green)';
        showToast('Thanks for the feedback! ðŸ‘');
        
        // Increment progress if user likes explanation
        if (userProfile && userProfile.subjects) {
          userProfile.subjects.forEach(subject => {
            incrementProgress(subject, 2);
          });
        }
      } else if (type === 'dislike') {
        btn.style.color = 'var(--acc-red)';
        showToast('We\'ll try to explain better next time');
        setTimeout(() => {
          addSimplifyButton(message);
        }, 1000);
      }
      
      console.log(`User reacted ${type} to message:`, messageText.substring(0, 50) + '...');
    }

    function copyMessage(btn) {
      const message = btn.closest('.msg');
      const messageText = message.textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(messageText).then(() => {
          btn.style.color = 'var(--acc-1)';
          showToast('Message copied to clipboard! ðŸ“‹');
          
          setTimeout(() => {
            btn.style.color = '';
          }, 2000);
        }).catch(err => {
          showToast('Failed to copy message', 'error');
          console.error('Copy failed:', err);
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = messageText;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('Message copied to clipboard! ðŸ“‹');
          btn.style.color = 'var(--acc-1)';
          setTimeout(() => {
            btn.style.color = '';
          }, 2000);
        } catch (err) {
          showToast('Failed to copy message', 'error');
        }
        document.body.removeChild(textArea);
      }
    }

    function addSimplifyButton(messageElement) {
      const simplifyBtn = document.createElement('div');
      simplifyBtn.className = 'simplify-suggestion';
      simplifyBtn.textContent = 'ðŸ”„ Explain this simpler';
      simplifyBtn.onclick = () => {
        const originalText = messageElement.textContent;
        askQuestion(`Please explain this in simpler terms: ${originalText.substring(0, 100)}...`);
      };
      
      messageElement.appendChild(simplifyBtn);
    }

    /* ====== SESSION DELETE FUNCTIONALITY ====== */
    function deleteSession(sessionId, event) {
      event.stopPropagation();
      
      showConfirmModal(
        'ðŸ—‘ï¸ Delete Conversation?',
        'This conversation will be permanently deleted.',
        async () => {
          try {
            sessions = sessions.filter(session => session.id !== sessionId);
            
            if (currentSessionId === sessionId) {
              currentSessionId = null;
              if (userProfile) {
                showPersonalizedWelcome();
              } else {
                showOnboardingState();
              }
            }
            
            renderSessions();
            showToast('Conversation deleted');
            
          } catch (error) {
            console.error('Failed to delete session:', error);
            showToast('Failed to delete conversation', 'error');
          }
        }
      );
    }

    /* ====== ONBOARDING SYSTEM ====== */
    function renderOnboardingStep() {
      const step = onboardingSteps[currentOnboardingStep];
      document.getElementById('onboardingTitle').textContent = step.title;
      document.getElementById('onboardingSubtitle').textContent = step.subtitle;
      
      const optionsGrid = document.getElementById('optionsGrid');
      optionsGrid.innerHTML = '';
      
      step.options.forEach((option, index) => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.dataset.value = option.id;
        card.tabIndex = 0; // Make focusable
        card.innerHTML = `
          <span class="option-emoji">${option.emoji}</span>
          <div class="option-title">${option.title}</div>
          <div class="option-desc">${option.desc}</div>
        `;
        
        // Enhanced interaction
        const selectOption = () => selectOptionHandler(option.id, step.multiple);
        card.addEventListener('click', selectOption);
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectOption();
          }
        });
        
        // Staggered animation
        card.style.animationDelay = (index * 0.1) + 's';
        optionsGrid.appendChild(card);
      });
      
      // Update step indicator
      const dots = document.querySelectorAll('.step-dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index <= currentOnboardingStep);
      });
      
      updateContinueButton();
    }

    function selectOptionHandler(value, multiple = false) {
      const stepKey = `step_${currentOnboardingStep}`;
      
      if (multiple) {
        if (!selectedOptions[stepKey]) selectedOptions[stepKey] = [];
        const index = selectedOptions[stepKey].indexOf(value);
        if (index > -1) {
          selectedOptions[stepKey].splice(index, 1);
        } else {
          selectedOptions[stepKey].push(value);
        }
      } else {
        selectedOptions[stepKey] = value;
      }
      
      // Update visual selection with better animation
      document.querySelectorAll('.option-card').forEach(card => {
        const isSelected = multiple ? 
          (selectedOptions[stepKey] && selectedOptions[stepKey].includes(card.dataset.value)) :
          (card.dataset.value === selectedOptions[stepKey]);
        
        card.classList.toggle('selected', isSelected);
        
        // Add selection animation
        if (isSelected) {
          card.style.animation = 'none';
          card.offsetHeight; // Trigger reflow
          card.style.animation = 'selectionPulse 0.6s ease';
        }
      });
      
      updateContinueButton();
    }

    function updateContinueButton() {
      const stepKey = `step_${currentOnboardingStep}`;
      const hasSelection = selectedOptions[stepKey] && 
        (Array.isArray(selectedOptions[stepKey]) ? selectedOptions[stepKey].length > 0 : true);
      
      const continueBtn = document.getElementById('continueBtn');
      continueBtn.classList.toggle('enabled', hasSelection);
      
      if (currentOnboardingStep === onboardingSteps.length - 1) {
        continueBtn.textContent = 'Complete Setup âœ¨';
      } else {
        continueBtn.textContent = 'Continue';
      }
    }

    function nextStep() {
      const stepKey = `step_${currentOnboardingStep}`;
      if (!selectedOptions[stepKey]) return;
      
      if (currentOnboardingStep < onboardingSteps.length - 1) {
        currentOnboardingStep++;
        renderOnboardingStep();
      } else {
        completeOnboarding();
      }
    }

    function completeOnboarding() {
      userProfile = {
        grade: selectedOptions.step_0,
        subjects: selectedOptions.step_1,
        learningStyle: selectedOptions.step_2,
        createdAt: Date.now()
      };
      
      localStorage.setItem('sophic_profile', JSON.stringify(userProfile));
      console.log('ðŸŽ¯ User Profile Created:', userProfile);
      showPersonalizedWelcome();
    }

    /* ====== ENHANCED PERSONALIZED SYSTEM ====== */
    function showPersonalizedWelcome() {
      onboardingState.classList.remove('active');
      chatTitle.textContent = `Welcome to your personalized Sophic!`;
      
      setTimeout(() => {
        renderPersonalizedCards();
        personalizedWelcome.classList.add('active');
      }, 300);
    }

    function renderPersonalizedCards() {
      const welcomeTitle = document.getElementById('welcomeTitle');
      const welcomeSubtitle = document.getElementById('welcomeSubtitle');
      const personalCards = document.getElementById('personalCards');
      
      welcomeTitle.textContent = `Ready to learn, Class ${userProfile.grade} student!`;
      welcomeSubtitle.textContent = `Here's your personalized learning dashboard`;
      
      const cards = generatePersonalizedCards();
      personalCards.innerHTML = '';
      
      cards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        cardElement.className = 'personal-card';
        cardElement.tabIndex = 0; // Make focusable
        cardElement.style.animationDelay = (index * 0.15) + 's';
        
        let progressHTML = '';
        if (card.progress !== undefined) {
          progressHTML = `
            <div class="progress-bar">
              <div class="progress-fill" data-target="${card.progress}" style="--target-width: ${card.progress}%"></div>
            </div>
            <div class="progress-text">${card.progress}% Complete</div>
          `;
        }
        
        cardElement.innerHTML = `
          <div class="card-header">
            <div class="card-icon">${card.icon}</div>
            <div class="card-info">
              <h3>${card.title}</h3>
              <div class="card-subtitle">${card.subtitle}</div>
            </div>
          </div>
          <div class="card-description">${card.description}</div>
          ${progressHTML}
        `;
        
        // Enhanced interaction
        const clickHandler = () => {
          if (card.context) {
            cardContext = card.context;
          }
          if (card.question) {
            askQuestion(card.question);
          }
        };
        
        cardElement.addEventListener('click', clickHandler);
        cardElement.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            clickHandler();
          }
        });
        
        personalCards.appendChild(cardElement);
        
        // Animate progress bars after card is added
        if (card.progress !== undefined) {
          setTimeout(() => {
            const progressFill = cardElement.querySelector('.progress-fill');
            if (progressFill) {
              progressFill.classList.add('animated');
            }
          }, (index * 150) + 500);
        }
      });
    }

    function generatePersonalizedCards() {
      const cards = [];
      const grade = userProfile.grade;
      const subjects = userProfile.subjects || ['math'];
      const style = userProfile.learningStyle;
      
      // Continue Learning Cards with persistent progress
      if (subjects.includes('math')) {
        const mathProgress = getOrCreateProgress('math');
        cards.push({
          icon: 'ðŸ“',
          title: 'Continue Math Journey',
          subtitle: `Class ${grade} Mathematics`,
          description: 'Pick up where you left off with quadratic equations',
          progress: mathProgress,
          question: `I'm a class ${grade} student learning math. Explain quadratic equations step by step with examples.`,
          context: {
            type: 'continue_learning',
            subject: 'mathematics',
            grade: grade,
            chapter: 'quadratic_equations',
            learningStyle: style
          }
        });
      }
      
      if (subjects.includes('physics')) {
        const physicsProgress = getOrCreateProgress('physics');
        cards.push({
          icon: 'âš¡',
          title: 'Physics Lab',
          subtitle: 'Real-world applications',
          description: 'Discover how physics works in everyday life',
          progress: physicsProgress,
          question: `Show me real-world physics examples for a class ${grade} student with ${style} learning style.`,
          context: {
            type: 'practical_application',
            subject: 'physics',
            grade: grade,
            learningStyle: style
          }
        });
      }
      
      if (subjects.includes('chemistry')) {
        const chemProgress = getOrCreateProgress('chemistry');
        cards.push({
          icon: 'ðŸ§ª',
          title: 'Chemistry Corner',
          subtitle: 'Experiments & reactions',
          description: 'Explore the world of elements and compounds',
          progress: chemProgress,
          question: `Explain chemistry concepts for class ${grade} using ${style} approach with practical examples.`,
          context: {
            type: 'practical_learning',
            subject: 'chemistry',
            grade: grade,
            learningStyle: style
          }
        });
      }
      
      // Quick Review Card
      cards.push({
        icon: 'âš¡',
        title: 'Quick 5-Min Review',
        subtitle: 'Bite-sized learning',
        description: 'Perfect for when you have just a few minutes',
        question: `Give me a quick 5-minute review of important class ${grade} topics in ${subjects.join(', ')} using ${style} approach.`,
        context: {
          type: 'quick_review',
          subjects: subjects,
          grade: grade,
          learningStyle: style
        }
      });
      
      // Homework Helper
      cards.push({
        icon: 'ðŸ“',
        title: 'Homework Helper',
        subtitle: 'Step-by-step solutions',
        description: 'Get help with your current assignments',
        question: `I'm a class ${grade} student who learns best with ${style} approach. Help me with my homework step by step.`,
        context: {
          type: 'homework_help',
          grade: grade,
          learningStyle: style
        }
      });
      
      // Learning Style Specific Card
      if (style === 'visual') {
        cards.push({
          icon: 'ðŸŽ¨',
          title: 'Visual Learning Hub',
          subtitle: 'Diagrams and examples',
          description: 'Learn through visual aids and illustrations',
          question: `I'm a visual learner in class ${grade}. Explain concepts using diagrams, charts, and visual examples.`,
          context: {
            type: 'visual_learning',
            grade: grade,
            subjects: subjects
          }
        });
      } else if (style === 'storytelling') {
        cards.push({
          icon: 'ðŸ“–',
          title: 'Story Mode Learning',
          subtitle: 'Learn through narratives',
          description: 'Complex topics made simple through stories',
          question: `I learn best through stories. Explain class ${grade} topics through interesting narratives and examples.`,
          context: {
            type: 'story_based',
            grade: grade,
            subjects: subjects
          }
        });
      } else if (style === 'practical') {
        cards.push({
          icon: 'ðŸ”§',
          title: 'Hands-On Learning',
          subtitle: 'Real-world applications',
          description: 'See how concepts apply in practice',
          question: `Show me practical applications of class ${grade} concepts that I can try myself.`,
          context: {
            type: 'practical_learning',
            grade: grade,
            subjects: subjects
          }
        });
      }
      
      // Challenge Card
      if (subjects.length > 0) {
        const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
        cards.push({
          icon: 'ðŸ†',
          title: 'Challenge Yourself',
          subtitle: `Advanced ${randomSubject}`,
          description: 'Ready for something more challenging?',
          question: `I'm ready for advanced ${randomSubject} problems for class ${grade}. Challenge me with difficult concepts using ${style} teaching method.`,
          context: {
            type: 'advanced_challenge',
            subject: randomSubject,
            grade: grade,
            learningStyle: style
          }
        });
      }
      
      return cards.slice(0, 6);
    }

    /* ====== ENHANCED CHAT SYSTEM ====== */
    async function handleFormSubmit() {
      const message = userInput.value.trim();
      if (!message) return;

      console.log('ðŸš€ NUCLEAR SEND:', message);
      
      // Show loading state
      const sendBtn = document.getElementById('send');
      sendBtn.classList.add('loading');

      addMessage(message, 'user');
      
      userInput.value = '';
      userInput.style.height = '22px';
      showTyping();

      try {
        const requestBody = {
          question: message,
          session_id: currentSessionId,
          user_context: userProfile
        };
        
        if (cardContext) {
          requestBody.card_context = cardContext;
          cardContext = null;
        }

        const response = await fetch('https://sophic-backend-fl4w.onrender.com/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        hideTyping();
        currentSessionId = data.session_id;
        
        const botResponse = data.answer || 'I apologize, but I couldn\'t generate a proper response. Please try asking again.';
        
        setTimeout(() => {
          addMessage(botResponse, 'bot');
          
          // Increment progress when user gets help
          if (userProfile && userProfile.subjects) {
            userProfile.subjects.forEach(subject => {
              incrementProgress(subject, 1);
            });
          }
          
          setTimeout(() => {
            if (window.MathJax && window.MathJax.typesetPromise) {
              MathJax.typesetPromise();
            }
          }, 100);
          
          if (data.suggestions && data.suggestions.length > 0) {
            setTimeout(() => {
              updateSuggestions(data.suggestions);
            }, 400);
          } else {
            generateContextSuggestions();
          }
        }, 800);

        // Update title with emoji fix
        if (chatTitle.textContent === 'Let\'s personalize your learning journey!' || 
            chatTitle.textContent.includes('Welcome to your personalized')) {
          const newTitle = data.meta?.session_title || (message.length > 30 ? message.substring(0, 30) + '...' : message);
          chatTitle.textContent = newTitle;
          // Remove gradient class to show emojis properly
          chatTitle.classList.remove('gradient-text');
        }

        setTimeout(() => {
          loadSessions();
        }, 1000);
        
      } catch (error) {
        hideTyping();
        setTimeout(() => {
          addMessage('I apologize, but I encountered a technical issue. Please check that the API server is running and try again.', 'bot');
        }, 300);
        console.error('ðŸ’¥ NUCLEAR ERROR:', error);
        showToast('Connection error. Please try again.', 'error');
      } finally {
        sendBtn.classList.remove('loading');
        userInput.focus();
      }
    }

    function generateContextSuggestions() {
      if (!userProfile) return;
      
      const suggestions = [];
      const grade = userProfile.grade;
      const subjects = userProfile.subjects;
      const style = userProfile.learningStyle;
      
      suggestions.push(`Explain this for a class ${grade} student`);
      
      if (style === 'visual') {
        suggestions.push('Show me diagrams and examples');
      } else if (style === 'stepbystep') {
        suggestions.push('Break this into detailed steps');
      } else if (style === 'storytelling') {
        suggestions.push('Explain this through a story');
      } else if (style === 'practical') {
        suggestions.push('Show me real-world applications');
      }
      
      if (subjects && subjects.includes('math')) {
        suggestions.push('Give me practice problems');
      }
      
      suggestions.push('How does this apply in real life?');
      suggestions.push('Quiz me on this topic');
      
      if (suggestions.length > 0) {
        updateSuggestions(suggestions.slice(0, 4));
      }
    }

    function loadQueryFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('q');
      
      if (query) {
        console.log('ðŸŽ¯ NUCLEAR QUERY FROM HOMEPAGE:', query);
        
        userInput.value = query;
        userInput.style.height = '22px';
        userInput.style.height = Math.max(22, Math.min(userInput.scrollHeight, 90)) + 'px';
        
        if (!userProfile) {
          userProfile = {
            grade: '10',
            subjects: ['math', 'physics'],
            learningStyle: 'stepbystep'
          };
          localStorage.setItem('sophic_profile', JSON.stringify(userProfile));
        }
        
        showChatState();
        setTimeout(() => {
          handleFormSubmit();
        }, 1000);
      }
    }

    // Enhanced input handling with debouncing
    const debouncedResize = debounce((element) => {
      element.style.height = '22px';
      element.style.height = Math.max(22, Math.min(element.scrollHeight, 90)) + 'px';
    }, 50);

    userInput.addEventListener('input', function() {
      debouncedResize(this);
    });

    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (userInput.value.trim()) {
          handleFormSubmit();
        }
      }
    });

    function showChatState() {
      onboardingState.classList.remove('active');
      personalizedWelcome.classList.remove('active');
      setTimeout(() => {
        chatState.classList.add('active');
        // Scroll to bottom
        setTimeout(() => {
          if (messages.scrollHeight > messages.clientHeight) {
            messages.scrollTop = messages.scrollHeight;
          }
        }, 100);
      }, 300);
      
      if (window.innerWidth <= 1024) {
        sidebar.classList.remove('open');
        if (mobileMenuToggle) mobileMenuToggle.classList.remove('active');
        navOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    function showOnboardingState() {
      chatState.classList.remove('active');
      personalizedWelcome.classList.remove('active');
      setTimeout(() => {
        onboardingState.classList.add('active');
        renderOnboardingStep();
      }, 100);
      chatTitle.textContent = 'Let\'s personalize your learning journey!';
    }

    function addMessage(text, who) {
      showChatState();
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      
      if (who === 'bot') {
        div.innerHTML = marked.parse(String(text || ''));
        addMessageReactions(div, true);
      } else {
        div.textContent = String(text || '');
      }
      
      div.style.animationDelay = '0.05s';
      messages.appendChild(div);
      
      requestAnimationFrame(() => {
        messages.scrollTo({
          top: messages.scrollHeight,
          behavior: 'smooth'
        });
      });
    }

    function showTyping() {
      const typing = document.createElement('div');
      typing.className = 'typing';
      typing.id = 'typing';
      typing.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      messages.appendChild(typing);
      
      requestAnimationFrame(() => {
        messages.scrollTo({
          top: messages.scrollHeight,
          behavior: 'smooth'
        });
      });
    }

    function hideTyping() {
      const typing = document.getElementById('typing');
      if (typing) {
        typing.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => typing.remove(), 300);
      }
    }

    function updateSuggestions(suggestionsList) {
      suggestions.innerHTML = '';
      if (!Array.isArray(suggestionsList) || suggestionsList.length === 0) return;
      
      suggestionsList.forEach((suggestion, index) => {
        const chip = document.createElement('div');
        chip.className = 'suggestion';
        chip.textContent = suggestion;
        chip.tabIndex = 0; // Make focusable
        chip.style.animationDelay = (index * 0.1) + 's';
        
        const clickHandler = () => {
          userInput.value = suggestion;
          userInput.focus();
          debouncedResize(userInput);
        };
        
        chip.addEventListener('click', clickHandler);
        chip.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            clickHandler();
          }
        });
        
        suggestions.appendChild(chip);
      });
    }

    // API functions with error handling
    async function loadSessions() {
      try {
        const response = await fetch('https://sophic-backend-fl4w.onrender.com/sessions');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        sessions = data.sessions || [];
        renderSessions();
      } catch (error) {
        console.error('ðŸ’¥ Failed to load sessions:', error);
        // Show empty state instead of error for better UX
        sessions = [];
        renderSessions();
      }
    }

    function renderSessions() {
      sessionsList.innerHTML = '';
      if (sessions.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'session';
        emptyState.innerHTML = `
          <div class="session-content">
            <div class="session-title">No conversations yet</div>
            <div class="session-preview">Start chatting to see your history</div>
          </div>
        `;
        emptyState.style.opacity = '0.6';
        emptyState.style.cursor = 'default';
        emptyState.style.transform = 'none';
        sessionsList.appendChild(emptyState);
        return;
      }
      
      sessions.forEach((session, index) => {
        const sessionDiv = document.createElement('div');
        sessionDiv.className = `session ${session.id === currentSessionId ? 'active' : ''}`;
        sessionDiv.tabIndex = 0; // Make focusable
        sessionDiv.style.animationDelay = (index * 0.03) + 's';
        
        sessionDiv.innerHTML = `
          <div class="session-content">
            <div class="session-title">${session.title || 'Untitled Chat'}</div>
            <div class="session-preview">${session.preview || `${session.message_count || 0} messages`}</div>
          </div>
          <button class="delete-session" onclick="deleteSession('${session.id}', event)" title="Delete conversation">Ã—</button>
        `;
        
        const loadSessionHandler = () => loadSession(session.id);
        const contentEl = sessionDiv.querySelector('.session-content');
        contentEl.onclick = loadSessionHandler;
        
        sessionDiv.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            loadSessionHandler();
          }
        });
        
        sessionsList.appendChild(sessionDiv);
      });
    }

    async function loadSession(sessionId) {
      try {
        currentSessionId = sessionId;
        const response = await fetch(`https://sophic-backend-fl4w.onrender.com/sessions/${sessionId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        chatTitle.textContent = data.title || 'Chat';
        chatTitle.classList.remove('gradient-text'); // Fix emoji display
        messages.innerHTML = '';
        showChatState();
        
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach((msg, index) => {
            setTimeout(() => {
              addMessage(msg.content, msg.role === 'assistant' ? 'bot' : msg.role);
            }, index * 150);
          });
        }
        
        renderSessions();
      } catch (error) {
        console.error('ðŸ’¥ Failed to load session:', error);
        showToast('Failed to load conversation', 'error');
      }
    }

    function startNewChat() {
      currentSessionId = null;
      messages.innerHTML = '';
      suggestions.innerHTML = '';
      
      if (userProfile) {
        showPersonalizedWelcome();
      } else {
        showOnboardingState();
      }
      
      renderSessions();
      userInput.focus();
    }

    function askQuestion(question) {
      userInput.value = question;
      debouncedResize(userInput);
      setTimeout(() => {
        handleFormSubmit();
      }, 300);
    }

    function renderMath() {
      if (window.MathJax) {
        MathJax.typesetPromise().catch(function (err) {
          console.log('ðŸ’¥ MathJax error: ' + err.message);
        });
      }
    }
    window.renderMath = renderMath;

    // Add selection pulse animation
    const selectionPulseKeyframes = `
      @keyframes selectionPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(110,168,255,0.5); }
        100% { transform: scale(1.02); }
      }
    `;
    
    // iOS keyboard handling
    function handleKeyboardResize() {
      const viewport = window.visualViewport;
      if (viewport) {
        viewport.addEventListener('resize', () => {
          const keyboardHeight = window.innerHeight - viewport.height;
          document.documentElement.style.setProperty('--keyboard-height', keyboardHeight + 'px');
        });
      }
    }

    // NUCLEAR INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('userInput');
      const button = document.getElementById('send');
      
      console.log('ðŸ”¥ NUCLEAR POLISHED CHAT INITIALIZED');
      
      if (!button || !input) {
        console.error('ðŸ’¥ CRITICAL SYSTEM FAILURE');
        return;
      }
      
      button.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸš€ NUCLEAR LAUNCH INITIATED');
        
        const message = input.value.trim();
        if (message) {
          handleFormSubmit();
        }
      };
      
      // Add keyboard handling
      handleKeyboardResize();
      
      // Add selection animation styles
      const style = document.createElement('style');
      style.textContent = selectionPulseKeyframes + `
        @keyframes fadeOut {
          0% { opacity: 1; transform: scale(1); }
          100% { opacity: 0; transform: scale(0.96); }
        }
      `;
      document.head.appendChild(style);
      
      const savedProfile = localStorage.getItem('sophic_profile');
      if (savedProfile) {
        try {
          userProfile = JSON.parse(savedProfile);
          console.log('ðŸ‘¤ User Profile Loaded:', userProfile);
          showPersonalizedWelcome();
        } catch (e) {
          console.error('Failed to parse saved profile:', e);
          localStorage.removeItem('sophic_profile');
          showOnboardingState();
        }
      } else {
        console.log('ðŸŽ¯ New User - Starting Onboarding');
        showOnboardingState();
      }
      
      loadSessions();
      loadQueryFromURL();
      input.focus();
      
      console.log('âœ¨ NUCLEAR POLISHED CHAT FULLY OPERATIONAL');
    });

    // Performance monitoring
    if ('performance' in window) {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const perfData = performance.getEntriesByType('navigation')[0];
          console.log(`ðŸš€ Page loaded in ${Math.round(perfData.loadEventEnd - perfData.fetchStart)}ms`);
        }, 0);
      });
    }

    console.log('ðŸ”¥ðŸ’ŽðŸš€âœ¨ NUCLEAR POLISHED PERSONALIZED LEARNING SYSTEM FULLY LOADED! âœ¨ðŸš€ðŸ’ŽðŸ”¥');
  </script>
</body>
</html>

